{% extends 'base.html' %}

{% load static %}
{% load widget_tweaks %}
{% load i18n %}

{% block metainfo %}
    <link rel="stylesheet" href="{% static 'css/signup.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap-grid.css">
    {#    <link rel="stylesheet" href="{% static 'css/rotate-button.css' %}">#}
    <script src="{% static 'js/jquery.validate.min.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular.min.js"></script>
    <style>
        .input-license-number-container input, .input-company-info-container input, .input-address-container input {
            height: 30px;
        }

        .hide {
            display: none;
        }

        @media (min-width: 768px) {
            .sign-up-professional-img {
                height: 100px;
                width: 100px;
            }
        }

        @media (max-width: 767px) {
            .sign-up-professional-img {
                height: 50px;
                width: 50px;
            }

            figcaption {
                font-size: 10px;
            }
        }

        #pro-list {
            margin-left: 35%;
            width: 300px;
            max-height: 200px;
            border: 1px solid #dedede;
            border-radius: 3px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .pro-results {
          background: antiquewhite;
          padding: 10px;
        }

    .isselected{
        background: yellow;
    }

    .unselected{
        background: white;
    }

    </style>
{% endblock %}
{#!!!!!#}
{% block content %}
    <div class="container container-sign-up-professional-profile-form" ng-app="pro">
        <form class="sign-up-professional-profile-form" id="professionalProfileForm" method="post"
              action="{% url 'account_professional_profile_after_signup' %}" ng-controller="professionalCtrl">
            {% csrf_token %}
            <input id="one" type="radio" class="stages-radio-input" name="stage" checked="checked"/>
            <input id="two" type="radio" class="stages-radio-input" name="stage"/>
            <input id="three" type="radio" class="stages-radio-input" name="stage"/>
            <input id="four" type="radio" class="stages-radio-input" name="stage"/>
            <input id="five" type="radio" class="stages-radio-input" name="stage"/>

            <div class="stages">
                <label for="one" class="stages-label">1</label>
                <label for="two" class="stages-label">2</label>
                <label for="three" class="stages-label">3</label>
                <label for="four" class="stages-label">4</label>
                <label for="five" class="stages-label">5</label>
            </div>

            <span class="progress"><span></span></span>

            <div class="panels">
                {% if form.errors or form.non_field_errors %}
                    <div class="alert alert-warning">
                        {% for field in form %} {{ field.errors|escape }}{% endfor %}
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}
                <div data-panel="one" id="stage-one">
                    <h4>{% trans "Find Your License In Our Database" %}</h4>
                    <div>{% trans "If you don't have license, please skip this step." %}</div>
                    <div class="input-license-number-container">
                        <div class="error-container"></div>
                        {% trans "License Number" %} : {{ form.license_num|attr:"ng-model:professional.licNum" }}
                        <div id="pro-list" ng-show="prodata.length > 0">
                            <div class="pro-results" ng-class="{isselected:$index===proId, unselected: $index!==proId}" ng-repeat="pro in prodata" ng-click="proSelect($index)">
                                name: {[{ pro.name }]}  address: {[{ pro.address1 }]} {[{ pro.address2 }]} {[{$index}]}
                            </div>
                        </div>
                    </div>
                </div>
                <div data-panel="two" id="stage-two">
                    <h4>{% trans "Choose License Type" %}</h4>
                    <div>{% trans "If you don't have license, please choose meister." %} </div>
                    <ul id="id_professional_type" class="input-professional-type-container row">
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_0">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="CONTRACTOR"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_0"
                                       ng-model="professional.protype.contractor">
                                <figure>
                                    <img class='sign-up-professional-img' alt="contractor"
                                         active="{% static 'image/sign-up-info-icon/contractor.png' %}"
                                         inactive="{% static 'image/sign-up-info-icon/contractor-inactive.png' %}"
                                         src="{% static 'image/sign-up-info-icon/contractor-inactive.png' %}">
                                    <figcaption>{{ Contractor }}</figcaption>
                                </figure>
                            </label>
                        </li>
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_1">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="ARCHITECT"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_1"
                                       ng-model="professional.protype.architect">
                                <figure>
                                    <img class='sign-up-professional-img' alt="architect"
                                         active="{% static 'image/sign-up-info-icon/architect.png' %}"
                                         inactive="{% static 'image/sign-up-info-icon/architect-inactive.png' %}"
                                         src="{% static 'image/sign-up-info-icon/architect-inactive.png' %}">
                                    <figcaption>{{ Architect }}</figcaption>
                                </figure>
                            </label>
                        </li>
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_2">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="DESIGNER"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_2"
                                       ng-model="professional.protype.designer">
                                <figure>
                                    <img class='sign-up-professional-img' alt="designer"
                                         active="{% static 'image/sign-up-info-icon/designer.png' %}"
                                         inactive="{% static 'image/sign-up-info-icon/designer-inactive.png' %}"
                                         src="{% static 'image/sign-up-info-icon/designer-inactive.png' %}">
                                    <figcaption>{{ Designer }}</figcaption>
                                </figure>
                            </label>
                        </li>
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_3">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="MEISTER"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_3"
                                       ng-model="professional.protype.meister">
                                <figure>
                                    <img class='sign-up-professional-img' alt="meister"
                                         active="{% static 'image/sign-up-info-icon/meister.svg' %}"
                                         inactive="{% static 'image/sign-up-info-icon/meister-inactive.svg' %}"
                                         src="{% static 'image/sign-up-info-icon/meister-inactive.svg' %}">
                                    <figcaption>{{ Meister }}</figcaption>
                                </figure>
                            </label>
                        </li>
                    </ul>
                </div>
                <div data-panel="three" id="stage-three">
                    <h4>{% trans "Enter Or Modify Business Name and Entity Type" %}</h4>
                    {#                    <h4 class="meister-hide">{% trans "Enter Or Modify BusName and Entity Type" %}</h4>#}
                    <div class="input-company-info-container">
                        <div class="error-container"></div>
                        {#                        {% trans "Your Name" %} : {{ form.personal_name }} </br></br>#}
                        {% trans "Business Name" %} : {{ form.company_name|attr:"ng-model:professional.company_name" }} </br></br>
                        {% trans "Entity Type" %} : {{ form.entity_type|attr:"ng-model:professional.entity_type" }}
                    </div>
                </div>
                <div data-panel="four" id="stage-four">
                    {#                    TODO: add validation rule none#}
                    <h4>{% trans "Enter Or Modify Your Service Category" %}</h4>
                    <div class="input-professional-subtype-container">
                        <div class="error-container"></div>
                        {{ form.professional_subtype }}
                    </div>
                </div>
                <div data-panel="five" id="stage-five">
                    <h4>{% trans "Enter Or Modify Your Company Address" %}</h4>
                    <div class="input-address-container">
                        <div class="error-container"></div>
{#                        #TODO: need to chake here. from street to address#}
                        {% trans "Street Address 1" %}:{{ form.address1|attr:"ng-model:professional.address1" }} </br></br>
                        {% trans "Street Address 2" %}:{{ form.address2|attr:"ng-model:professional.address2" }} </br></br>
                        {% trans "County/City" %}:{{ form.county|attr:"ng-model:professional.county" }} </br></br>
                        {% trans "State" %}:{{ form.state|attr:"ng-model:professional.state" }} </br></br>
                        {% trans "Zipcode" %}:{{ form.zipcode|attr:"ng-model:professional.zipcode" }} </br></br>
                        {% trans "Phone Number" %}: {{ form.phone|attr:"ng-model:professional.phone" }} </br>
                        {{ form.uuid|attr:"ng-model:professional.uuid"|attr:"ng-value:professional.uuid" }}
                    </div>
                </div>
            </div>
            <div style="width:100%;">
                <button type="submit" id="next" class="btn btn-hoome"
                        style="display:table ;margin: 0 auto;">{% trans "Next" %}</button>
            </div>

        </form>
    </div>

    <script type="text/javascript">
        var globalTimeout = null;
        //    TODO: add more robusic logic here
        $(function () {
            const rules = {
                professional_type: 'required',
                license_num: {
                    required: true,
                    number: true
                },
                company_name: 'required',
                entity_type: 'required',
                professional_subtype: 'required',
                street: 'required',
                state: 'required',
                zipcode: {
                    required: true,
                    number: true
                }
            };
            {#            TODO: add a validation rule: consider postal code situation#}
            const messages = {
                professional_type: "Please choose your field",
                license_num: {
                    required: "We need your license number",
                    number: "Your license number must be a number"
                },
                company_name: "Please specify your company name",
                entity_type: "Please choose your company entity type",
                professional_subtype: "Please choose your professional field",
                street: "Please specify your company street",
                state: "Please specify your company state",
                zipcode: {
                    required: "Please specify your company postal code",
                    number: "Please enter correct postal code"
                }
            };

            const stageValidator = $('#professionalProfileForm').validate({
                rules: rules,
                messages: messages,
                errorPlacement: function (error, element) {
                    error.addClass('alert alert-warning').appendTo(element.parent().parent().find('.error-container'));
                },
                highlight: function (element) {

                },
                unhighlight: function (element) {

                }
            });

            $('#next').click(function (event) {
                var radioButtons = $('.stages-radio-input');
                var selectedIndex = radioButtons.index(radioButtons.filter(':checked'));
                selectedIndex = selectedIndex + 1;
                if (selectedIndex === 1) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (selectedIndex === 2) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (selectedIndex === 3) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (selectedIndex === 4) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (!stageValidator.form()) {
                    console.log("test");
                    event.preventDefault();
                    alert("Please complete form");
                } else {
                    console.log("sucess");
                    $('#next').submit();
                }
            });

            $('#id_professional_type').find('label').click(function () {
                $('input[name=professional_type]:checked').parent().find('figure img').attr('src', function () {
                    return $(this).attr('active');
                });
                $('input[name=professional_type]:not(:checked)').parent().find('figure img').attr('src', function () {
                    return $(this).attr('inactive');
                });
            });
        });

        var pro = angular.module('pro', []);
        pro.config(function($interpolateProvider, $httpProvider){
            $interpolateProvider.startSymbol('{[{');
            $interpolateProvider.endSymbol('}]}');
            $httpProvider.defaults.xsrfCookieName = 'csrftoken';
            $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
        });

        pro.factory('proFunc', function($http, $q){
            var service = {};
            var imgMeister = angular.element('img[alt="meister"]');
            var imgArchitect = angular.element('img[alt="architect"]');
            var imgDesigner = angular.element('img[alt="designer"]');
            var imgContractor = angular.element('img[alt="contractor"]');

            service.proSearch = function(licNum){
                var data = {'lic_num': licNum};
                var deferred = $q.defer();
                $http.post('/accounts/signup/info/profession/', data).then(function(result){
                    deferred.resolve(result.data);
                });
                return deferred.promise;
            };
            service.proAssign = function(professional, proSelected){
                if(proSelected !== null){
                    professional.address1 = proSelected.address1;
                    professional.address2 = proSelected.address2;
                    professional.zipcode = proSelected.pos_code;
                    professional.county = proSelected.county;
                    professional.state = proSelected.state;
                    professional.phone = proSelected.phone;
                    professional.company_name = proSelected.owner_name;
                    professional.entity_type = proSelected.entity_type;
                    professional.uuid = proSelected.uuid;
                    professional.protype.meister = false;
                    imgMeister.prop('src', imgMeister.attr('inactive'));
                } else{
                    professional.address1 = '';
                    professional.address2 = '';
                    professional.zipcode = '';
                    professional.county = '';
                    professional.state = '';
                    professional.phone = '';
                    professional.company_name = '';
                    professional.entity_type = null;
                    professional.protype.architect = false;
                    professional.protype.contractor = false;
                    professional.protype.designer = false;
                    imgMeister.prop('src', imgMeister.attr('active'));
                    imgArchitect.prop('src', imgArchitect.attr('inactive'));
                    imgDesigner.prop('src', imgDesigner.attr('inactive'));
                    imgContractor.prop('src', imgContractor.attr('inactive'));
                }
            };
            service.proTypeCtrl = function(protype, proId){
                if(proId === null){
                    protype.meister = true;
                    protype.architect = false;
                    protype.contractor = false;
                    protype.designer = false;
                    imgMeister.prop('src', imgMeister.attr('active'));
                    imgArchitect.prop('src', imgArchitect.attr('inactive'));
                    imgDesigner.prop('src', imgDesigner.attr('inactive'));
                    imgContractor.prop('src', imgContractor.attr('inactive'));
                } else{
                    protype.meister = false;
                    imgMeister.prop('src', imgMeister.attr('inactive'));
                }
            };
            return service;
        });

        pro.controller('professionalCtrl', ["$scope", "$timeout", "proFunc", function($scope, $timeout, proFunc){
            $scope.professional = {'protype': {}};
            $scope.prodata = {};
            $scope.proId = null;
            $scope.$watch('professional.licNum', function(newVal, oldVal){
                if(newVal !== oldVal){
                    $timeout(function() {
                        var proSearch = proFunc.proSearch($scope.professional.licNum);
                        proSearch.then(function(data){
                            $scope.prodata = data;
                        })
                    }, 800);
                }
            });
            $scope.$watch('professional.protype', function(){
                proFunc.proTypeCtrl($scope.professional.protype, $scope.proId);
            }, true);
            $scope.$watch('prodata.length', function(){
                if($scope.prodata.length === 0){
                    proFunc.proAssign($scope.professional, null);
                }
            });
            $scope.proSelect = function(proId){
                console.log(proId);
                $scope.proId = proId;
                proFunc.proAssign($scope.professional, $scope.prodata[$scope.proId]);
            }
        }]);
    </script>
{% endblock %}
