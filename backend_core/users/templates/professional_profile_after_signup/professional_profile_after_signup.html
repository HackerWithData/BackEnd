{% extends 'base.html' %}

{% load static %}

{% load i18n %}

{% block metainfo %}
    <link rel="stylesheet" href="{% static 'css/signup.css' %}">
    {#    <link rel="stylesheet" href="{% static 'css/rotate-button.css' %}">#}
    <script src="{% static 'js/jquery.validate.min.js' %}"></script>
    <style>
        .input-license-number-container input, .input-company-info-container input, .input-address-container input {
            height: 30px;
        }

        .hide {
            display: none;
        }

        @media (min-width: 768px) {
            .sign-up-professional-img {
                height: 200px;
                width: 200px;
            }
        }

        @media (max-width: 767px) {
            .sign-up-professional-img {
                height: 50px;
                width: 50px;
            }

            figcaption {
                font-size: 10px;
            }
        }
    </style>
{% endblock %}
{#!!!!!#}
{% block content %}
    <div class="container container-sign-up-professional-profile-form">
        <form class="sign-up-professional-profile-form" id="professionalProfileForm" method="post"
              action="{% url 'account_professional_profile_after_signup' %}">
            {% csrf_token %}
            <input id="one" type="radio" class="stages-radio-input" name="stage" checked="checked"/>
            <input id="two" type="radio" class="stages-radio-input" name="stage"/>
            <input id="three" type="radio" class="stages-radio-input" name="stage"/>
            <input id="four" type="radio" class="stages-radio-input" name="stage"/>
            <input id="five" type="radio" class="stages-radio-input" name="stage"/>

            <div class="stages">
                <label for="one" class="stages-label">1</label>
                <label for="two" class="stages-label">2</label>
                <label for="three" class="stages-label">3</label>
                <label for="four" class="stages-label">4</label>
                <label for="five" class="stages-label">5</label>
            </div>

            <span class="progress"><span></span></span>

            <div class="panels">
                {% if form.errors or form.non_field_errors %}
                <div class="alert alert-warning">
                    {% for field in form %} {{ field.errors|escape }}{% endfor %}
                    {{ form.non_field_errors }}
                </div>
                {% endif %}
                <div data-panel="one" id="stage-one">
                    <h4>{% trans "Find Your License In Our Database" %}</h4>
                    <div>{% trans "If you don't have license, please skip this step." %}</div>
                    <div class="input-license-number-container">
                        <div class="error-container"></div>
                        {% trans "License Number" %} : {{ form.license_num }}
                        <div id="professionals_info"></div>
                        <input type="hidden" name="professional_selection" value='-1'/>
                    </div>
                </div>
                <div data-panel="two" id="stage-two">
                    <h4>{% trans "Choose License Type" %}</h4>
                    <div>{% trans "If you don't have license, please choose meister." %} </div>
                    <ul id="id_professional_type" class="input-professional-type-container row">
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_0">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="CONTRACTOR"
                                       required=""
                                       checked=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_0">
                                <figure>
                                    <img class='sign-up-professional-img' alt="contractor"
                                         active="{% static 'image/sign-up-info-icon/contractor.png' %}"
                                         inactive="{% static 'image/sign-up-info-icon/contractor-inactive.png' %}"
                                         src="{% static 'image/sign-up-info-icon/contractor.png' %}">
                                    <figcaption>{{ Contractor }}</figcaption>
                                </figure>
                            </label>
                        </li>
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_1">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="ARCHITECT"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_1">
                                <figure>
                                    <img class='sign-up-professional-img' alt="architect"
                                         active="{% static 'image/sign-up-info-icon/architect.png' %}"
                                         inactive="{% static 'image/sign-up-info-icon/architect-inactive.png' %}"
                                         src="{% static 'image/sign-up-info-icon/architect-inactive.png' %}">
                                    <figcaption>{{ Architect }}</figcaption>
                                </figure>
                            </label>
                        </li>
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_2">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="DESIGNER"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_2">
                                <figure>
                                    <img class='sign-up-professional-img' alt="designer"
                                         active="{% static 'image/sign-up-info-icon/designer.png' %}"
                                         inactive="{% static 'image/sign-up-info-icon/designer-inactive.png' %}"
                                         src="{% static 'image/sign-up-info-icon/designer-inactive.png' %}">
                                    <figcaption>{{ Designer }}</figcaption>
                                </figure>
                            </label>
                        </li>
                        <li class="col-xs-3 col-sm-6 col-md-3">
                            <label for="id_professional_type_3">
                                <input type="checkbox"
                                       name="professional_type"
                                       value="MEISTER"
                                       required=""
                                       class="input-professional-type-container"
                                       id="id_professional_type_3">
                                <figure>
                                    <img class='sign-up-professional-img' alt="meister"
                                         active="{% static 'image/sign-up-info-icon/meister.svg' %}"
                                         inactive="{% static 'image/sign-up-info-icon/meister-inactive.svg' %}"
                                         src="{% static 'image/sign-up-info-icon/meister-inactive.svg' %}">
                                    <figcaption>{{ Meister }}</figcaption>
                                </figure>
                            </label>
                        </li>
                    </ul>
                </div>
                <div data-panel="three" id="stage-three">
                    <h4 >{% trans "Enter Or Modify Business Name and Entity Type" %}</h4>
{#                    <h4 class="meister-hide">{% trans "Enter Or Modify BusName and Entity Type" %}</h4>#}
                    <div class="input-company-info-container">
                        <div class="error-container"></div>
{#                        {% trans "Your Name" %} : {{ form.personal_name }} </br></br>#}
                        {% trans "Business Name" %} : {{ form.company_name }} </br></br>
                        {% trans "Entity Type" %} : {{ form.entity_type }}
                    </div>
                </div>
                <div data-panel="four" id="stage-four">
                    {#                    TODO: add validation rule none#}
                    <h4>{% trans "Enter Or Modify Your Service Category" %}</h4>
                    <div class="input-professional-subtype-container">
                        <div class="error-container"></div>
                        {{ form.professional_subtype }}
                    </div>
                </div>
                <div data-panel="five" id="stage-five">
                    <h4>{% trans "Enter Or Modify Your Company Address" %}</h4>
                    <div class="input-address-container">
                        <div class="error-container"></div>
                        {% trans "Street" %}:{{ form.street }} </br></br>
                        {% trans "County/City" %}:{{ form.county }} </br></br>
                        {% trans "State" %}:{{ form.state }} </br></br>
                        {% trans "Zipcode" %}:{{ form.zipcode }} </br></br>
                        {% trans "Phone Number" %}: {{ form.phone }} </br>
                        {{ form.uuid }}
                    </div>
                </div>
            </div>
            {#            <div class="button-container next-button">#}
            {#                <button type="submit" id="next" class="button-cube">#}
            {#                    <div class="front">#}
            {#                        {% trans "Next" %}#}
            {#                    </div>#}
            {#                    <div class="bottom">#}
            {#                        {% trans "Next" %}#}
            {#                    </div>#}
            {#                </button>#}
            {#            </div>#}
            <div style="width:100%;">
                <button type="submit" id="next" class="btn btn-hoome"
                        style="display:table ;margin: 0 auto;">{% trans "Next" %}</button>
            </div>

        </form>
    </div>

    <script type="text/javascript">
        var globalTimeout = null;
        //    TODO: add more robusic logic here
        $(function () {
            const rules = {
                professional_type: 'required',
                license_num: {
                    required: true,
                    number: true
                },
                company_name: 'required',
                entity_type: 'required',
                professional_subtype: 'required',
                street: 'required',
                state: 'required',
                zipcode: {
                    required: true,
                    number: true
                }
            };
            {#            TODO: add a validation rule: consider postal code situation#}
            const messages = {
                professional_type: "Please choose your field",
                license_num: {
                    required: "We need your license number",
                    number: "Your license number must be a number"
                },
                company_name: "Please specify your company name",
                entity_type: "Please choose your company entity type",
                professional_subtype: "Please choose your professional field",
                street: "Please specify your company street",
                state: "Please specify your company state",
                zipcode: {
                    required: "Please specify your company postal code",
                    number: "Please enter correct postal code"
                }
            };

            const stageValidator = $('#professionalProfileForm').validate({
                rules: rules,
                messages: messages,
                errorPlacement: function (error, element) {
                    error.addClass('alert alert-warning').appendTo(element.parent().parent().find('.error-container'));
                },
                highlight: function (element) {

                },
                unhighlight: function (element) {

                }
            });

            $('#next').click(function (event) {
                var radioButtons = $('.stages-radio-input');
                var selectedIndex = radioButtons.index(radioButtons.filter(':checked'));
                selectedIndex = selectedIndex + 1;
                if (selectedIndex === 1) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (selectedIndex === 2) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (selectedIndex === 3) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (selectedIndex === 4) {
                    console.log(stageValidator.form());
                    if (stageValidator.form()) {
                        event.preventDefault();
                        $('.stages-radio-input').eq(selectedIndex).prop('checked', true);
                    }
                } else if (!stageValidator.form()) {
                    console.log("test");
                    event.preventDefault();
                    alert("Please complete form");
                } else {
                    console.log("sucess");
                    $('#next').submit();
                }
            });

            $('#id_professional_type').find('label').click(function () {
                $('input[name=professional_type]:checked').parent().find('figure img').attr('src', function () {
                    return $(this).attr('active');
                });
                $('input[name=professional_type]:not(:checked)').parent().find('figure img').attr('src', function () {
                    return $(this).attr('inactive');
                });
            });

{#            @@@@@#}
            var professionals_info;
            $('#id_license_num').bind('input propertychange', function() {
                var lic_num = $(this).val();
                $.ajax({
                    type: "POST",
                    url: "{% url 'account_professional_profile_after_signup' %}",
                    beforeSend: function (request) {
                        request.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                    },
                    data: JSON.stringify({'lic_num': lic_num}),
                    contentType: "application/json;",
                    dataType: "json"
                }).done(function(data){
                    if(data.length > 0) {
                        professionals_info = data;
                        for (var i in professionals_info) {
                            var professional = professionals_info[i];
                            $("#professionals_info").append(
                                '<input type="radio" name="professional_selection" value=' + i  + '>' +
                                    'name: ' + professional.name +
                                    '\t address: ' + professional.address +
                                    '\t type: ' + professional.type + '<br/>'
                            );
                        }
                    }
                    else{
                        $("#professionals_info").html('');
                    }
                });
            });
            var select_professional = function (pro_query_id) {
                var type_0 = $('#id_professional_type_0');
                var type_1 = $('#id_professional_type_1');
                var type_2 = $('#id_professional_type_2');
                var type_3 = $('#id_professional_type_3');
                professional_selected_id = Number(pro_query_id);
                if(professional_selected_id === -1){
                    type_0.prop('checked', false);
                    type_1.prop('checked', false);
                    type_2.prop('checked', false);
                    type_3.prop('checked', true);
                } else if(professional_selected_id >= 0){
                    type_3.prop('checked', false);
                    var professional_selected = professionals_info[professional_selected_id];
                    console.log(professional_selected);
                    $('#id_company_name').val(professional_selected.name);
                    $('#id_zipcode').val(professional_selected.pos_code);
                    $('#id_street').val(professional_selected.address);
                    $('#id_county').val(professional_selected.county);
                    $('#id_state').val(professional_selected.state);
                    $('#id_uuid').val(professional_selected.uuid);
                    $('#id_phone').val(professional_selected.phone);
                }
            };
            var professional_selected_id = -1;
            select_professional(professional_selected_id);
            $('#professionals_info').click(function(){
                var id = $('input[name="professional_selection"]:checked').val();
                if(typeof id !== 'undefined'){
                    select_professional(id);
                }
            });
        });


    </script>
{% endblock %}
